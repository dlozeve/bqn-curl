âŸ¨
  # Simple API
  Get,Post,
  # Advanced API
  OpenSession,ResetSession,CloseSession,  # session management
  SetURL,SetHeaders,SetVerbose,SetTimeout,SetTimeoutms,SetPost,SetData,  # request parameters
  Perform,  # perform request
âŸ©â‡

âŸ¨
  easyInit,
  easyCleanup,
  easyReset,
  easySetoptStr,
  easySetoptPtr,
  easySetoptLong,
  easyPerform,
  easyGetinfoStr,
  easyGetinfoLong,
  easyGetinfoDouble,
  slistAppend,
  slistFreeAll,
  fopen,
  fclose,
  curlOptions,
  curlInfo
âŸ©â†â€¢Import"ffi.bqn"
âŸ¨RandIDâŸ©â†â€¢Import"utils.bqn"

# Simple GET request, with optional headers as left argument
Getâ†{
ğ•Š url: âŸ¨âŸ© ğ•Š url ;
headers ğ•Š url:
  sessionâ†OpenSession @
  râ†Perform headers SetHeaders url SetURL session
  CloseSession session
  r
}

# Simple POST request, with optional headers as left argument
Postâ†{
ğ•Š urlâ€¿data: âŸ¨âŸ© ğ•Š urlâ€¿data ;
headers ğ•Š urlâ€¿data:
  sessionâ†OpenSession @
  râ†Perform data SetData SetPost headers SetHeaders url SetURL session
  CloseSession session
  r
}

# Raise an error if the return code ğ•© is not 0, with custom message ğ•¨
Checkâ†{
  msgâ†"Curl: "âˆ¾ğ•¨âˆ¾" ("âˆ¾(â€¢Fmt ğ•©)âˆ¾")"
  msg ! ğ•©=0
}

# Create a libcurl session, with default values for user-agent and redirects
OpenSessionâ†{ğ•Šğ•©:
  sessionPtrâ†EasyInitâŸ¨âŸ©
  "setting user agent"Check EasySetoptStrâŸ¨sessionPtr,curlOptions.useragent,"curl/bqn"âˆ¾@âŸ©
  "setting redirect option"Check EasySetoptLongâŸ¨sessionPtr,curlOptions.followlocation,1âŸ©
  slistâ†SlistAppendâŸ¨8â†‘0,""âŸ©
  "creating slist" ! slistâ‰¢8â†‘0
  {sessionPtrâ‡sessionPtr,headersSlistâ‡slist}
}

# Reset a libcurl session to default parameters, as if just created by
# OpenSession, but preserving open connections and caches
ResetSessionâ†{ğ•Š session:
  SlistFreeAll session.headersSlist
  EasyReset session.sessionPtr
  "setting user agent"Check EasySetoptStrâŸ¨session.sessionPtr,curlOptions.useragent,"curl/bqn"âˆ¾@âŸ©
  "setting redirect option"Check EasySetoptLongâŸ¨session.sessionPtr,curlOptions.followlocation,1âŸ©
  slistâ†SlistAppendâŸ¨8â†‘0,""âŸ©
  "creating slist" ! slistâ‰¢8â†‘0
  {sessionPtrâ‡session.sessionPtr,headersSlistâ‡slist}
}

# Close a libcurl session, freeing memory
CloseSessionâ†{ğ•Š session:
  SlistFreeAll session.headersSlist
  EasyCleanup session.sessionPtr
  @
}

# Set URL for the next request
SetURLâ†{url ğ•Š session:
  "setting URL"Check EasySetoptStrâŸ¨session.sessionPtr,curlOptions.url,urlâˆ¾@âŸ©
  session
}

# Set headers for the next request, as a list of strings
SetHeadersâ†{headers ğ•Š session:
  slistâ†session.headersSlist{SlistAppendâŸ¨ğ•©,ğ•¨âˆ¾@âŸ©}Â´headers
  "setting headers"Check rheadersâ†EasySetoptPtrâŸ¨session.sessionPtr,curlOptions.httpHeader,slistâŸ©
  session
}

# Set the next request as verbose (logging to standard output)
SetVerboseâ†{ğ•Š session:
  "setting verbose option"Check EasySetoptLongâŸ¨session.sessionPtr,curlOptions.verbose,1âŸ©
  session
}

# Set timeout in seconds for the next request
SetTimeoutâ†{timeout ğ•Š session:
  "setting timeout"Check EasySetoptLongâŸ¨session.sessionPtr,curlOptions.timeout,timeoutâŸ©
  session
}

# Set timeout in milliseconds for the next request
SetTimeoutmsâ†{timeoutms ğ•Š session:
  "setting timeout (ms)"Check EasySetoptLongâŸ¨session.sessionPtr,curlOptions.timeoutms,timeoutmsâŸ©
  session
}

# Use a POST method for the next request
SetPostâ†{ğ•Š session:
  "setting up POST request"Check EasySetoptLongâŸ¨session.sessionPtr,curlOptions.post,1âŸ©
  session
}

# Set data to post
SetDataâ†{data ğ•Š session:
  "setting POST data"Check EasySetoptStrâŸ¨session.sessionPtr,curlOptions.postfields,dataâŸ©
  "setting POST data size"Check EasySetoptLongâŸ¨session.sessionPtr,curlOptions.postfieldsize,â‰ dataâŸ©
  session
}

# Perform a request and get response in a namespace
Performâ†{ğ•Š session:
  idâ†RandID 32
  filenameâ†"/tmp/bqncurl."âˆ¾id
  filePtrâ†FopenâŸ¨filenameâˆ¾@,"w+"âŸ©
  headerFilenameâ†"/tmp/bqncurl.header."âˆ¾id
  headerFilePtrâ†FopenâŸ¨headerFilenameâˆ¾@,"w+"âŸ©
  "setting response file target"Check EasySetoptPtrâŸ¨session.sessionPtr,curlOptions.writedata,filePtrâŸ©
  "setting header file target"Check EasySetoptPtrâŸ¨session.sessionPtr,curlOptions.headerdata,headerFilePtrâŸ©

  "performing request"Check EasyPerformâŸ¨session.sessionPtrâŸ©

  rcodeâ€¿âŸ¨codeâŸ©â†EasyGetinfoLongâŸ¨session.sessionPtr,curlInfo.responseCode,âŸ¨0âŸ©âŸ©
  "retrieving response code"Check rcode
  rtimeâ€¿âŸ¨timeâŸ©â†EasyGetinfoDoubleâŸ¨session.sessionPtr,curlInfo.totalTime,âŸ¨0.0âŸ©âŸ©
  "retrieving request time"Check rtime

  Fclose filePtr
  Fclose headerFilePtr

  contentâ†â€¢file.Bytes filename
  responseHeadersâ†â€¢file.Chars headerFilename

  â€¢file.Remove filename
  â€¢file.Remove headerFilename

  {
    codeâ‡code,
    timeâ‡time,
    headersâ‡responseHeaders,
    contentâ‡content,
  }
}
