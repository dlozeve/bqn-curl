âŸ¨Get,PostâŸ©â‡

âŸ¨
  easyInit,
  easyCleanup,
  easySetoptStr,
  easySetoptPtr,
  easySetoptLong,
  easyPerform,
  easyGetinfoStr,
  easyGetinfoLong,
  easyGetinfoDouble,
  slistAppend,
  slistFreeAll,
  fopen,
  fclose,
  curlOptions,
  curlInfo
âŸ©â†â€¢Import"ffi.bqn"
âŸ¨RandIDâŸ©â†â€¢Import"utils.bqn"

PrepareRequestâ†{session ğ•Š urlâ€¿headers:
  idâ†RandID 32
  filenameâ†"/tmp/bqncurl."âˆ¾id
  filePtrâ†FopenâŸ¨filenameâˆ¾@,"w+"âŸ©
  headerFilenameâ†"/tmp/bqncurl.header."âˆ¾id
  headerFilePtrâ†FopenâŸ¨headerFilenameâˆ¾@,"w+"âŸ©

  ruseragentâ†EasySetoptStrâŸ¨session,curlOptions.useragent,"curl/bqn"âˆ¾@âŸ©
  ("Error setting user agent: "âˆ¾â€¢Fmt ruseragent)!ruseragent=0
  rurlâ†EasySetoptStrâŸ¨session,curlOptions.url,urlâˆ¾@âŸ©
  ("Error setting URL: "âˆ¾â€¢Fmt rurl)!rurl=0
  rfileâ†EasySetoptPtrâŸ¨session,curlOptions.writedata,filePtrâŸ©
  ("Error setting file target: "âˆ¾â€¢Fmt rfile)!rfile=0
  rheaderfileâ†EasySetoptPtrâŸ¨session,curlOptions.headerdata,headerFilePtrâŸ©
  ("Error setting header file target: "âˆ¾â€¢Fmt rheaderfile)!rheaderfile=0
  rredirectâ†EasySetoptLongâŸ¨session,curlOptions.followlocation,1âŸ©
  ("Error setting redirect option: "âˆ¾â€¢Fmt rredirect)!rredirect=0
  # EasySetoptLongâŸ¨session,curlOptions.header,1âŸ©
  # EasySetoptLongâŸ¨session,curlOptions.verbose,1âŸ©

  slistâ†(8â†‘0){SlistAppendâŸ¨ğ•©,ğ•¨âˆ¾@âŸ©}Â´headers
  rheadersâ†EasySetoptPtrâŸ¨session,curlOptions.httpHeader,slistâŸ©
  ("Error setting headers: "âˆ¾â€¢Fmt rheaders)!rheaders=0

  slistâ€¿filenameâ€¿filePtrâ€¿headerFilenameâ€¿headerFilePtr
}

ReadResponseâ†{session ğ•Š slistâ€¿filenameâ€¿filePtrâ€¿headerFilenameâ€¿headerFilePtr:
  SlistFreeAll slist

  rcodeâ€¿âŸ¨codeâŸ©â†EasyGetinfoLongâŸ¨session,curlInfo.responseCode,âŸ¨0âŸ©âŸ©
  ("Error retrieving response code: "âˆ¾â€¢Fmt rcode)!rcode=0
  rtimeâ€¿âŸ¨timeâŸ©â†EasyGetinfoDoubleâŸ¨session,curlInfo.totalTime,âŸ¨0.0âŸ©âŸ©
  ("Error retrieving request time: "âˆ¾â€¢Fmt rtime)!rtime=0

  Fclose filePtr
  Fclose headerFilePtr

  contentâ†â€¢file.Bytes filename
  responseHeadersâ†â€¢file.Chars headerFilename

  â€¢file.Remove filename
  â€¢file.Remove headerFilename

  {
    codeâ‡code,
    timeâ‡time,
    headersâ‡responseHeaders,
    contentâ‡content,
  }
}

Getâ†{
ğ•Š url: âŸ¨âŸ© ğ•Š url ;
headers ğ•Š url:
  sessionâ†EasyInitâŸ¨âŸ©
  dâ†session PrepareRequest urlâ€¿headers

  rperformâ†EasyPerformâŸ¨sessionâŸ©
  ("Error performing request: "âˆ¾â€¢Fmt rperform)!rperform=0

  responseâ†session ReadResponse d
  EasyCleanup session
  response
}

Postâ†{
ğ•Š urlâ€¿data: âŸ¨âŸ© ğ•Š urlâ€¿data ;
headers ğ•Š urlâ€¿data:
  sessionâ†EasyInitâŸ¨âŸ©
  dâ†session PrepareRequest urlâ€¿headers
  rpostâ†EasySetoptLongâŸ¨session,curlOptions.post,1âŸ©
  ("Error setting up POST request: "âˆ¾â€¢Fmt rpost)!rpost=0
  rpostfieldsâ†EasySetoptStrâŸ¨session,curlOptions.postfields,dataâŸ©
  ("Error setting POST data: "âˆ¾â€¢Fmt rpostfields)!rpostfields=0
  rpostfieldsizeâ†EasySetoptLongâŸ¨session,curlOptions.postfieldsize,â‰ dataâŸ©
  ("Error setting POST data size: "âˆ¾â€¢Fmt rpostfieldsize)!rpostfieldsize=0

  rperformâ†EasyPerformâŸ¨sessionâŸ©
  ("Error performing request: "âˆ¾â€¢Fmt rperform)!rperform=0

  responseâ†session ReadResponse d
  EasyCleanup session
  response
}
