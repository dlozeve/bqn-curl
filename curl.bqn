âŸ¨Get,PostâŸ©â‡

âŸ¨
  easyInit,
  easyCleanup,
  easySetoptStr,
  easySetoptPtr,
  easySetoptLong,
  easyPerform,
  easyGetinfoStr,
  easyGetinfoLong,
  easyGetinfoDouble,
  slistAppend,
  slistFreeAll,
  fopen,
  fclose,
  curlOptions,
  curlInfo
âŸ©â†â€¢Import"ffi.bqn"
âŸ¨RandIDâŸ©â†â€¢Import"utils.bqn"

Checkâ†{
  msgâ†"Curl: "âˆ¾ğ•¨âˆ¾" ("âˆ¾(â€¢Fmt ğ•©)âˆ¾")"
  msg ! ğ•©=0
}

PrepareRequestâ†{session ğ•Š urlâ€¿headers:
  idâ†RandID 32
  filenameâ†"/tmp/bqncurl."âˆ¾id
  filePtrâ†FopenâŸ¨filenameâˆ¾@,"w+"âŸ©
  headerFilenameâ†"/tmp/bqncurl.header."âˆ¾id
  headerFilePtrâ†FopenâŸ¨headerFilenameâˆ¾@,"w+"âŸ©

  "setting user agent"Check EasySetoptStrâŸ¨session,curlOptions.useragent,"curl/bqn"âˆ¾@âŸ©
  "setting URL"Check EasySetoptStrâŸ¨session,curlOptions.url,urlâˆ¾@âŸ©
  "setting file target"Check EasySetoptPtrâŸ¨session,curlOptions.writedata,filePtrâŸ©
  "setting header file target"Check EasySetoptPtrâŸ¨session,curlOptions.headerdata,headerFilePtrâŸ©
  "setting redirect option"Check EasySetoptLongâŸ¨session,curlOptions.followlocation,1âŸ©
  # "setting verbosity"Check EasySetoptLongâŸ¨session,curlOptions.verbose,1âŸ©
  slistâ†(8â†‘0){SlistAppendâŸ¨ğ•©,ğ•¨âˆ¾@âŸ©}Â´headers
  "setting headers"Check rheadersâ†EasySetoptPtrâŸ¨session,curlOptions.httpHeader,slistâŸ©

  slistâ€¿filenameâ€¿filePtrâ€¿headerFilenameâ€¿headerFilePtr
}

ReadResponseâ†{session ğ•Š slistâ€¿filenameâ€¿filePtrâ€¿headerFilenameâ€¿headerFilePtr:
  SlistFreeAll slist

  rcodeâ€¿âŸ¨codeâŸ©â†EasyGetinfoLongâŸ¨session,curlInfo.responseCode,âŸ¨0âŸ©âŸ©
  "retrieving response code"Check rcode
  rtimeâ€¿âŸ¨timeâŸ©â†EasyGetinfoDoubleâŸ¨session,curlInfo.totalTime,âŸ¨0.0âŸ©âŸ©
  "retrieving request time"Check rtime

  Fclose filePtr
  Fclose headerFilePtr

  contentâ†â€¢file.Bytes filename
  responseHeadersâ†â€¢file.Chars headerFilename

  â€¢file.Remove filename
  â€¢file.Remove headerFilename

  {
    codeâ‡code,
    timeâ‡time,
    headersâ‡responseHeaders,
    contentâ‡content,
  }
}

Getâ†{
ğ•Š url: âŸ¨âŸ© ğ•Š url ;
headers ğ•Š url:
  sessionâ†EasyInitâŸ¨âŸ©
  dâ†session PrepareRequest urlâ€¿headers

  "performing request"Check EasyPerformâŸ¨sessionâŸ©

  responseâ†session ReadResponse d
  EasyCleanup session
  response
}

Postâ†{
ğ•Š urlâ€¿data: âŸ¨âŸ© ğ•Š urlâ€¿data ;
headers ğ•Š urlâ€¿data:
  sessionâ†EasyInitâŸ¨âŸ©
  dâ†session PrepareRequest urlâ€¿headers
  "setting up POST request"Check EasySetoptLongâŸ¨session,curlOptions.post,1âŸ©
  "setting POST data"Check EasySetoptStrâŸ¨session,curlOptions.postfields,dataâŸ©
  "setting POST data size"Check EasySetoptLongâŸ¨session,curlOptions.postfieldsize,â‰ dataâŸ©

  "performing request"Check EasyPerformâŸ¨sessionâŸ©

  responseâ†session ReadResponse d
  EasyCleanup session
  response
}
