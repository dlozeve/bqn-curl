#!/usr/bin/env bqn
âŸ¨
  Get,Post,
  OpenSession,ResetSession,CloseSession,
  SetURL,SetHeaders,SetVerbose,SetTimeout,SetTimeoutms,SetData,
  Perform,
âŸ©â†â€¢Import"curl.bqn"

httpbinURLâ†"http://localhost:8080"

RunTestâ†{â€¢term.OutRaw (4â¥Š' ')âˆ¾"Test "âˆ¾ğ•¨ â‹„ ğ• @ â‹„ â€¢Out ((69-â‰ ğ•¨)â¥Š'.')âˆ¾"OK"}
RunSuiteâ†{â€¢Out ğ•¨âˆ¾':' â‹„ RunTestÂ´Â¨ğ•© â‹„ â€¢Out "    All "âˆ¾(â€¢Fmt â‰ ğ•©)âˆ¾" tests passed."}
RunAllâ†{RunSuiteÂ´Â¨ğ•© â‹„ â€¢Out "All "âˆ¾(â€¢Fmt +Â´â‰ Â¨âŠ¢Â´Â¨ğ•©)âˆ¾" tests passed."}

simpleAPI_testsuiteâ†âŸ¨
  "simple GET"â€¿{ğ•Šğ•©:
    râ†Get httpbinURLâˆ¾"/get"
    ! 200=r.code
    ! 0=r.redirectCount
    ! 1=âŠ‘"HTTP/"â·r.headers
    ! 1=+Â´"Content-Type: "â·r.headers
    ! 1=+Â´"Content-Length: "â·r.headers
    ! 1=+Â´"""Host"": ""localhost:8080"""â·r.content
    ! 1=+Â´"""User-Agent"": ""curl/bqn"""â·r.content
    ! 0=+Â´"""Hello"": ""World"""â·r.content
  },
  "simple GET with headers"â€¿{ğ•Šğ•©:
    headersâ†âŸ¨"User-Agent: toto","Content-Type: application/json","Hello: World"âŸ©
    râ†headers Get httpbinURLâˆ¾"/get"
    ! 200=r.code
    ! 0=r.redirectCount
    ! 1=+Â´"""Host"": ""localhost:8080"""â·r.content
    ! 1=+Â´"""User-Agent"": ""toto"""â·r.content
    ! 1=+Â´"""Content-Type"": ""application/json"""â·r.content
    ! 1=+Â´"""Hello"": ""World"""â·r.content
  },
  "simple POST with headers"â€¿{ğ•Šğ•©:
    headersâ†âŸ¨"Content-Type: application/json"âŸ©
    râ†headers Post âŸ¨httpbinURLâˆ¾"/post","{""key"": ""value""}"âŸ©
    ! 200=r.code
    ! 0=r.redirectCount
    ! 1=âŠ‘"HTTP/"â·r.headers
    ! 1=+Â´"Content-Type: "â·r.headers
    ! 1=+Â´"Content-Length: "â·r.headers
    ! 1=+Â´"""Content-Type"": ""application/json"""â·r.content
    ! 1=+Â´"""data"": ""{\""key\"": \""value\""}"""â·r.content
  }
âŸ©

advancedAPI_testsuiteâ†âŸ¨
  "open session"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    ! 8=â‰ session.sessionPtr
    ! (8â†‘0)â‰¢session.headersSlist
    CloseSession session
  },
  "GET"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    râ†Perform (httpbinURLâˆ¾"/get") SetURL session
    ! 200=r.code
    ! 0=r.redirectCount
    ! 10â‰¤â‰ r.content
    CloseSession session
  },
  "POST"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    râ†Perform "toto"SetData (httpbinURLâˆ¾"/post") SetURL session
    ! 200=r.code
    ! 0=r.redirectCount
    ! 1=+Â´"toto"â·r.content
    CloseSession session
  },
  "basic auth fail"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©(httpbinURLâˆ¾"/basic-auth/username/s3cr3tpa55word") SetURL session
    râ†Perform session
    ! 401=r.code
    CloseSession session
  },
  "basic auth with header"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©(httpbinURLâˆ¾"/basic-auth/username/s3cr3tpa55word") SetURL session
    râ†Perform âŸ¨"Authorization: Basic dXNlcm5hbWU6czNjcjN0cGE1NXdvcmQ="âŸ© SetHeaders session
    ! 200=r.code
    CloseSession session
  },
  "basic auth with URL"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©("http://username:s3cr3tpa55word@localhost:8080/basic-auth/username/s3cr3tpa55word") SetURL session
    râ†Perform session
    ! 200=r.code
    CloseSession session
  },
  "bearer auth fail"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©(httpbinURLâˆ¾"/bearer") SetURL session
    râ†Perform session
    ! 401=r.code
    CloseSession session
  },
  "bearer auth"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©(httpbinURLâˆ¾"/bearer") SetURL session
    râ†Perform âŸ¨"Authorization: Bearer hey!"âŸ© SetHeaders session
    ! 200=r.code
    CloseSession session
  },
  "status GET"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    râ†Perform (httpbinURLâˆ¾"/status/418") SetURL session
    ! 418=r.code
    CloseSession session
  },
  "status POST"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    râ†Perform ""SetData (httpbinURLâˆ¾"/status/418") SetURL session
    ! 418=r.code
    CloseSession session
  },
  "set headers"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©(httpbinURLâˆ¾"/headers") SetURL session
    râ†Perform âŸ¨"Hello: World"âŸ© SetHeaders session
    ! 1=+Â´"""Hello"": ""World"""â·r.content
    CloseSession session
  },
  "default user-agent"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©(httpbinURLâˆ¾"/user-agent") SetURL session
    râ†Perform session
    ! 1=+Â´"curl/bqn"â·r.content
    CloseSession session
  },
  "custom user-agent"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©(httpbinURLâˆ¾"/user-agent") SetURL session
    râ†Perform âŸ¨"User-Agent: hello/world"âŸ© SetHeaders session
    ! 0=+Â´"curl/bqn"â·r.content
    ! 1=+Â´"hello/world"â·r.content
    CloseSession session
  },
  "timeout with fast request"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©1010 SetTimeoutms (httpbinURLâˆ¾"/delay/1") SetURL session
    râ†Perform session
    ! 200=r.code
    CloseSession session
  },
  "request timeout"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    sessionâ†©100 SetTimeoutms (httpbinURLâˆ¾"/delay/1") SetURL session
    ! PerformâŠ1 session
    CloseSession session
  },
  "follow redirects"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    râ†Perform (httpbinURLâˆ¾"/redirect/5") SetURL session
    ! 200=r.code
    ! 5=r.redirectCount
    CloseSession session
  },
  "follow absolute redirects"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    râ†Perform (httpbinURLâˆ¾"/absolute-redirect/5") SetURL session
    ! 200=r.code
    ! 5=r.redirectCount
    CloseSession session
  },
  "follow relative redirects"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    râ†Perform (httpbinURLâˆ¾"/relative-redirect/5") SetURL session
    ! 200=r.code
    ! 5=r.redirectCount
    CloseSession session
  },
  "parameters"â€¿{ğ•Šğ•©:
    sessionâ†OpenSession @
    râ†Perform (httpbinURLâˆ¾"/anything?hello=world&zig=zag") SetURL session
    ! 1=+Â´"""hello"": ""world"""â·r.content
    ! 1=+Â´"""zig"": ""zag"""â·r.content
    CloseSession session
  },
âŸ©

RunAllâŸ¨
  "Simple API"â€¿simpleAPI_testsuite,
  "Advanced API"â€¿advancedAPI_testsuite,
âŸ©
